[include mainsail.cfg]
# This file contains common pin mappings for the BIGTREETECH Manta M8P V1.1
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication.

# See docs/Config_Reference.md for a description of parameters.
[include mcu_definitions/mantaM8P.cfg]
[include mcu_definitions/ebb36.cfg]
[include kinematics.cfg]
[include hardware/xy.cfg]
[include hardware/z.cfg]
[include hardware/temperature_sensors/ebb36_temp.cfg]
[include hardware/temperature_sensors/mcu_temp.cfg]
[include hardware/temperature_sensors/rpi_temp.cfg]
[include hardware/probe/qgl.cfg]
[include spoolman.cfg]
[include cartographer.cfg]
[include moonraker_obico_macros.cfg]

[force_move]
enable_force_move: true

[heater_bed]
heater_pin: PB5
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA0
##	Adjust Max Power so your heater doesn't warp your bed
max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[extruder]
step_pin: ebb36: PD0
dir_pin: !ebb36: PD1
enable_pin: !ebb36: PD2
microsteps: 16
rotation_distance: 3.8716598159876
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: ebb36: PB13
sensor_pin: ebb36: PA3
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: -250
max_temp: 250

## EXTRUDER MOTOR
[tmc2209 extruder]
uart_pin: ebb36: PA15
run_current: 0.650
stealthchop_threshold: 999999

[exclude_object]

[homing_override]
gcode:
    
    {% if not 'Z' in params and not 'Y' in params and 'X' in params %}
    _HOME_X
    {% elif not 'Z' in params and not 'X' in params and 'Y' in params %}
    _HOME_Y
    {% elif not 'Z' in params and 'X' in params and 'Y' in params %}
    _HOME_Y
    _HOME_X
    {% elif 'Z' in params and not 'X' in params and not 'Y' in params %}
    G28 Z
    G0 Z10
    {% else %}
    SET_KINEMATIC_POSITION HOMED_AXIS=Z0
    G0 Z10
    _HOME_Y
    _HOME_X
    G0 X85 Y85
    G28 Z
    G0 Z10
    
    {% endif %}
    
    
[gcode_macro _HOME_X]
gcode:
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 X F800
    # Move away
    G1 X10 F2000
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    
[gcode_macro _HOME_Y]
gcode:
    # Set current for sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 Y F800
    # Move away
    G1 Y10 F2000
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 2250
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.100
#*#
#*# [scanner model default]
#*# model_coef = 1.3599214991681838,
#*# 	1.800994868158209,
#*# 	0.7368526251356845,
#*# 	0.1839513625820262,
#*# 	0.5160581150370068,
#*# 	1.063833589819737,
#*# 	-0.4756891851867809,
#*# 	-1.2835206265579566,
#*# 	0.4113163441178701,
#*# 	0.6851381492479492
#*# model_domain = 3.145304241094606e-07,3.2989716930707365e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 43.451526
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.402030, -0.056372, -0.031062, -0.029338, -0.033692, -0.039806, -0.039748, -0.036560, -0.032182, -0.030469, -0.027531, -0.026521, -0.012977, -0.013160, 0.012464, -0.001259, 0.012159, -0.005546, -0.006523, -0.004696, -0.005252, 0.002092, 0.002297, 0.003727, 0.001695, 0.002563, -0.001656, -0.004625, -0.019975, -0.163817
#*# 	-0.397925, -0.057120, -0.030069, -0.028546, -0.029428, -0.034796, -0.035775, -0.033830, -0.029479, -0.026163, -0.022576, -0.020184, -0.010759, -0.003524, 0.006890, 0.004042, 0.005436, -0.001467, -0.006225, -0.001971, -0.003249, 0.004973, 0.004754, 0.007305, 0.006008, 0.003953, -0.000055, -0.007099, -0.020107, -0.167291
#*# 	-0.391822, -0.054801, -0.028555, -0.025624, -0.026237, -0.029774, -0.031265, -0.029426, -0.025034, -0.024054, -0.016786, -0.012731, -0.010610, 0.004753, 0.003995, 0.009626, 0.004713, -0.000018, -0.002063, -0.000144, -0.000077, 0.006535, 0.008123, 0.010282, 0.006696, 0.004708, -0.000073, -0.005278, -0.019558, -0.165161
#*# 	-0.377963, -0.050424, -0.025652, -0.023138, -0.024594, -0.025565, -0.027940, -0.024304, -0.020725, -0.018840, -0.011249, -0.007406, -0.009491, 0.008798, -0.001767, 0.009302, 0.003009, -0.001404, 0.003336, -0.000130, 0.001678, 0.005339, 0.007284, 0.010590, 0.006300, 0.003360, -0.000449, -0.001103, -0.018787, -0.164131
#*# 	-0.372175, -0.047019, -0.021705, -0.017602, -0.019861, -0.023983, -0.024153, -0.018671, -0.017503, -0.013828, -0.008926, 0.000052, -0.007617, 0.013958, -0.006794, 0.008526, 0.001457, 0.000107, 0.002748, 0.000682, 0.005240, 0.007797, 0.011745, 0.011949, 0.009405, 0.007804, 0.001689, 0.001226, -0.017915, -0.163878
#*# 	-0.367928, -0.044655, -0.021899, -0.016621, -0.017393, -0.022294, -0.021354, -0.015151, -0.015965, -0.009368, -0.009547, 0.006232, -0.005389, 0.016823, -0.004485, 0.006138, -0.001446, -0.001851, 0.000349, 0.002634, 0.005909, 0.009861, 0.015035, 0.014730, 0.012038, 0.007874, 0.001783, -0.003466, -0.017612, -0.171097
#*# 	-0.366072, -0.046358, -0.020971, -0.015854, -0.015979, -0.020911, -0.018864, -0.013497, -0.014256, -0.011057, -0.006370, 0.008078, -0.001298, 0.018438, 0.001377, 0.006075, -0.002457, -0.003354, 0.000199, 0.008318, 0.007007, 0.014878, 0.016517, 0.017288, 0.016893, 0.010728, 0.005238, -0.003619, -0.014079, -0.170402
#*# 	-0.360508, -0.047834, -0.021341, -0.015562, -0.015450, -0.020992, -0.020406, -0.015166, -0.011638, -0.016402, 0.004209, -0.004781, 0.006730, 0.012233, 0.004032, 0.005538, -0.001728, -0.004539, 0.000697, 0.007059, 0.009222, 0.014239, 0.017585, 0.017160, 0.014729, 0.011618, 0.007912, 0.001878, -0.012474, -0.169303
#*# 	-0.361047, -0.048720, -0.023348, -0.017369, -0.016680, -0.022818, -0.020940, -0.017263, -0.009678, -0.021737, 0.011994, -0.014171, 0.012243, 0.001801, 0.004890, 0.005326, -0.000393, -0.003814, 0.003131, 0.003209, 0.011786, 0.011808, 0.019939, 0.016313, 0.014683, 0.012046, 0.008629, 0.003837, -0.011734, -0.170249
#*# 	-0.358768, -0.053566, -0.026077, -0.020462, -0.019156, -0.025352, -0.022597, -0.019630, -0.010681, -0.019788, 0.010060, -0.014544, 0.008853, -0.004040, 0.006056, 0.005506, 0.002551, -0.004605, 0.003272, -0.001357, 0.011791, 0.008315, 0.013923, 0.010661, 0.013553, 0.009227, 0.009425, 0.002058, -0.012508, -0.173357
#*# 	-0.358119, -0.054284, -0.027572, -0.021442, -0.020119, -0.026958, -0.025325, -0.019117, -0.016551, -0.016369, -0.002313, -0.014412, -0.001919, -0.008359, 0.002942, 0.004116, 0.003419, -0.001897, 0.002000, 0.001112, 0.006108, 0.007866, 0.011736, 0.011834, 0.011781, 0.007967, 0.004001, 0.001429, -0.013526, -0.172652
#*# 	-0.350076, -0.053458, -0.027309, -0.021047, -0.020176, -0.028000, -0.026217, -0.017014, -0.024145, -0.012386, -0.017456, -0.009389, -0.010626, -0.005778, 0.002723, 0.004605, 0.007735, 0.002681, 0.002561, 0.002271, 0.006642, 0.014956, 0.012693, 0.011940, 0.015396, 0.010546, 0.007569, -0.004027, -0.014788, -0.174808
#*# 	-0.346620, -0.053644, -0.026899, -0.019830, -0.018821, -0.025450, -0.025975, -0.015073, -0.024988, -0.004138, -0.022549, 0.000793, -0.009771, 0.001450, 0.006292, 0.008041, 0.009311, 0.002771, 0.007104, 0.008334, 0.011294, 0.013317, 0.014809, 0.013654, 0.014094, 0.007891, 0.005433, 0.002544, -0.013445, -0.176238
#*# 	-0.339434, -0.051675, -0.025630, -0.017526, -0.017371, -0.024882, -0.025178, -0.016029, -0.021663, -0.002472, -0.019715, 0.006535, -0.008413, 0.006733, 0.007571, 0.005687, 0.011040, 0.002977, 0.008980, 0.008376, 0.011901, 0.012921, 0.017852, 0.013969, 0.015991, 0.011902, 0.011379, 0.005282, -0.012198, -0.175496
#*# 	-0.340392, -0.051406, -0.026303, -0.018794, -0.018183, -0.026830, -0.024525, -0.019570, -0.019073, -0.014310, -0.014328, 0.002093, -0.008288, 0.002399, 0.008326, 0.001387, 0.009408, 0.002081, 0.009195, 0.006172, 0.013032, 0.008712, 0.017463, 0.012077, 0.017362, 0.012241, 0.008678, 0.004499, -0.010606, -0.176102
#*# 	-0.337564, -0.053214, -0.028205, -0.022814, -0.020061, -0.028021, -0.025458, -0.019627, -0.009863, -0.023982, -0.008200, -0.006798, -0.005270, -0.002057, 0.009580, 0.002573, 0.010680, 0.004085, 0.010702, 0.006541, 0.015740, 0.009476, 0.017365, 0.014677, 0.016439, 0.012945, 0.009321, 0.006913, -0.008284, -0.175296
#*# 	-0.336926, -0.056422, -0.030986, -0.023714, -0.023255, -0.028470, -0.029794, -0.015103, -0.012646, -0.024303, -0.006459, -0.011699, -0.003812, -0.006177, 0.006892, 0.001577, 0.009487, 0.007831, 0.008466, 0.003120, 0.018456, 0.014018, 0.014590, 0.014050, 0.013767, 0.013735, 0.011910, 0.008113, -0.007263, -0.176269
#*# 	-0.332516, -0.053766, -0.030550, -0.022606, -0.026165, -0.025851, -0.034367, -0.011261, -0.021937, -0.016702, -0.013440, -0.017899, -0.010256, -0.004221, 0.002484, 0.005236, 0.006028, 0.012916, 0.005892, 0.005299, 0.017398, 0.013008, 0.014231, 0.014698, 0.011813, 0.010280, 0.007610, 0.005090, -0.010160, -0.178453
#*# 	-0.332823, -0.056866, -0.033628, -0.028070, -0.029609, -0.027737, -0.037167, -0.009412, -0.027728, -0.014200, -0.024309, -0.020349, -0.016207, -0.003364, 0.000602, 0.007004, 0.001001, 0.016680, 0.005290, 0.008104, 0.013749, 0.012017, 0.010677, 0.014503, 0.009285, 0.010355, 0.007285, 0.005134, -0.009857, -0.181380
#*# 	-0.331659, -0.057874, -0.036284, -0.029807, -0.026834, -0.029839, -0.035899, -0.016496, -0.028693, -0.016994, -0.027863, -0.019806, -0.018382, -0.007807, -0.000238, 0.003102, -0.000987, 0.009202, 0.000807, 0.004855, 0.007967, 0.009092, 0.009587, 0.014315, 0.005222, 0.010434, 0.005243, 0.003196, -0.012313, -0.185060
#*# 	-0.330066, -0.056558, -0.033862, -0.026616, -0.026216, -0.031717, -0.031596, -0.024184, -0.026712, -0.020583, -0.022944, -0.020165, -0.022778, -0.010752, -0.003914, 0.003461, -0.001374, 0.005222, -0.002348, -0.002512, 0.007829, 0.007781, 0.011120, 0.013198, 0.004820, 0.009835, 0.003737, 0.002301, -0.011044, -0.185563
#*# 	-0.326667, -0.056108, -0.034917, -0.027388, -0.027141, -0.030870, -0.029300, -0.030425, -0.024381, -0.020939, -0.018587, -0.016600, -0.020701, -0.009402, -0.008442, 0.006469, 0.000619, 0.003576, -0.001157, -0.004621, 0.006082, 0.006122, 0.008000, 0.009544, 0.006238, 0.005730, 0.004516, -0.000046, -0.014232, -0.186127
#*# 	-0.325620, -0.056171, -0.032297, -0.024242, -0.023389, -0.031017, -0.027378, -0.034974, -0.026111, -0.024550, -0.014618, -0.016338, -0.011755, -0.011217, -0.008644, 0.004590, -0.001935, 0.003418, -0.000953, -0.002685, 0.001898, 0.005277, 0.006033, 0.008475, 0.011548, 0.002805, 0.005912, 0.000326, -0.014194, -0.186819
#*# 	-0.322045, -0.057479, -0.030368, -0.024956, -0.024151, -0.029059, -0.025109, -0.032904, -0.024676, -0.023974, -0.013442, -0.015128, -0.008621, -0.007858, -0.007360, 0.003804, -0.003608, -0.004561, -0.000231, -0.004953, 0.002150, 0.004534, 0.005237, 0.009383, 0.012834, 0.004342, 0.008344, -0.001412, -0.014988, -0.188364
#*# 	-0.322132, -0.057566, -0.033752, -0.026042, -0.024878, -0.028163, -0.026257, -0.031563, -0.025598, -0.025447, -0.013547, -0.013918, -0.006714, -0.002675, -0.006882, 0.001156, -0.004125, -0.010590, -0.002106, -0.007146, 0.000051, 0.007252, 0.006411, 0.009900, 0.013994, 0.004797, 0.007031, 0.000096, -0.014312, -0.190039
#*# 	-0.318092, -0.057462, -0.034189, -0.026675, -0.024879, -0.027348, -0.033524, -0.031266, -0.028917, -0.026934, -0.018355, -0.016349, -0.009038, -0.003168, -0.007849, -0.004075, -0.004141, -0.009168, -0.009145, -0.005276, -0.007976, 0.010043, 0.011351, 0.006812, 0.012720, 0.004866, 0.006764, 0.001484, -0.016010, -0.190540
#*# 	-0.318153, -0.058122, -0.036411, -0.028222, -0.027493, -0.030613, -0.035663, -0.033617, -0.031957, -0.033613, -0.024181, -0.021953, -0.013058, -0.005325, -0.006394, -0.006864, -0.007363, -0.011346, -0.010526, -0.004353, -0.010648, -0.003497, 0.012117, 0.002975, 0.012195, 0.002817, 0.004808, -0.001470, -0.017542, -0.196740
#*# 	-0.317474, -0.059662, -0.036820, -0.029737, -0.029745, -0.031860, -0.035001, -0.036954, -0.035270, -0.037552, -0.030563, -0.029776, -0.018646, -0.012221, -0.008877, -0.009338, -0.013088, -0.014617, -0.012827, -0.005266, -0.006004, -0.007613, 0.004470, 0.001089, 0.009036, 0.004079, 0.001863, -0.002770, -0.019636, -0.200252
#*# 	-0.320540, -0.061451, -0.039284, -0.034442, -0.033570, -0.037630, -0.038696, -0.040991, -0.037120, -0.042282, -0.035483, -0.036924, -0.022421, -0.020419, -0.012299, -0.013254, -0.018370, -0.016404, -0.019047, -0.011883, -0.007060, -0.003349, -0.001446, 0.008804, -0.003871, 0.010429, -0.002715, -0.003383, -0.020165, -0.203537
#*# 	-0.321935, -0.065123, -0.042137, -0.042026, -0.036434, -0.039788, -0.038844, -0.042459, -0.036319, -0.041666, -0.035670, -0.037026, -0.024044, -0.025733, -0.012258, -0.015293, -0.020137, -0.020247, -0.021302, -0.016157, -0.011085, -0.002672, -0.004567, 0.009314, -0.009890, 0.007492, -0.002783, -0.007061, -0.022805, -0.207452
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 0.0
#*# max_x = 172.0
#*# min_y = 24.0
#*# max_y = 160.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 21.015
#*# pid_ki = 1.015
#*# pid_kd = 108.754
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 56.190
#*# pid_ki = 2.638
#*# pid_kd = 299.214
