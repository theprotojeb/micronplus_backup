[include mainsail.cfg]
# This file contains common pin mappings for the BIGTREETECH Manta M8P V1.1
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication.

# See docs/Config_Reference.md for a description of parameters.
[include mcu_definitions/mantaM8P.cfg]
[include mcu_definitions/ebb36.cfg]
[include kinematics.cfg]
[include hardware/xy.cfg]
[include hardware/z.cfg]
[include hardware/temperature_sensors/ebb36_temp.cfg]
[include hardware/temperature_sensors/mcu_temp.cfg]
[include hardware/temperature_sensors/rpi_temp.cfg]
[include hardware/probe/qgl.cfg]
[include spoolman.cfg]
[include cartographer.cfg]

[force_move]
enable_force_move: true

[heater_bed]
heater_pin: PB5
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA0
##	Adjust Max Power so your heater doesn't warp your bed
max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[extruder]
step_pin: ebb36: PD0
dir_pin: !ebb36: PD1
enable_pin: !ebb36: PD2
microsteps: 16
rotation_distance: 22.6789511
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: ebb36: PB13
sensor_pin: ebb36: PA3
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: -250
max_temp: 250

## EXTRUDER MOTOR
[tmc2209 extruder]
uart_pin: ebb36: PA15
run_current: 0.650
stealthchop_threshold: 999999

[exclude_object]

[homing_override]
gcode:

  {% if not 'Z' in params and not 'Y' in params and 'X' in params %}
  _HOME_X
  {% elif not 'Z' in params and not 'X' in params and 'Y' in params %}
  _HOME_Y
  {% elif not 'Z' in params and 'X' in params and 'Y' in params %}
  _HOME_Y
  _HOME_X
  G4 P1000
  _HOME_X
  {% elif 'Z' in params and not 'X' in params and not 'Y' in params %}
  G28 Z
  G0 Z10
  {% else %}
  SET_KINEMATIC_POSITION HOMED_AXIS=Z0
  G0 Z10
  SET_KINEMATIC_POSITION CLEAR_HOMED=Z
  _HOME_Y
  _HOME_X
  G0 X95 Y95
  G28 Z
  G0 Z10

  {% endif %} 


[gcode_macro _HOME_X]
gcode:
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 X F1200
    # Move away
    G91
    G1 X10 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    
[gcode_macro _HOME_Y]
gcode:
    # Set current for sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 Y F1200
    # Move away
    G91
    G1 Y10 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 2250
#*# scanner_touch_speed = 3
#*#
#*# [scanner model default]
#*# model_coef = 1.4567949142901828,
#*# 	  1.8007392816606367,
#*# 	  0.7505709248827926,
#*# 	  0.20959738125462896,
#*# 	  0.4947112841098304,
#*# 	  0.9868395424035715,
#*# 	  -0.47556059429887954,
#*# 	  -1.1892323887355645,
#*# 	  0.4211323282634881,
#*# 	  0.6426491136365875
#*# model_domain = 3.1452927560050783e-07,3.298925241050134e-07
#*# model_range = 0.199167,5.099167
#*# model_temp = 34.814699
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	-0.056584, -0.058359, -0.061148, -0.061186, -0.060835, -0.051737, -0.049700, -0.047227, -0.047763, -0.032987, -0.041680, -0.038108, -0.019599, -0.025668, 0.002038, -0.007568, -0.008269, -0.007459, -0.006238, -0.007699, 0.002786, -0.004024, -0.000110, 0.000958, 0.006966, 0.007656, 0.015595, 0.019279, 0.011973, 0.002658
#*# 	-0.059764, -0.055971, -0.057449, -0.051592, -0.051833, -0.054279, -0.057526, -0.051218, -0.049466, -0.040061, -0.037659, -0.031316, -0.011185, -0.016455, -0.002337, -0.010849, -0.008662, -0.010255, -0.008668, -0.010412, 0.003097, 0.002880, 0.009092, 0.004278, 0.010046, 0.010750, 0.010430, 0.015836, 0.019161, 0.016827
#*# 	-0.055428, -0.052632, -0.057488, -0.055863, -0.049906, -0.045329, -0.043668, -0.040236, -0.040364, -0.032464, -0.025830, -0.024955, -0.008101, -0.019072, -0.009986, -0.011570, -0.013317, -0.008926, -0.006328, -0.007134, 0.002600, 0.003205, 0.011599, 0.012980, 0.015248, 0.012393, 0.010803, 0.016391, 0.015633, 0.020707
#*# 	-0.047245, -0.045410, -0.046800, -0.052430, -0.057208, -0.050437, -0.050124, -0.036973, -0.032953, -0.026625, -0.019875, -0.026192, -0.007654, -0.017497, -0.012404, -0.004599, -0.008721, -0.008649, -0.006272, -0.002964, -0.001251, -0.001714, 0.010385, 0.016363, 0.015168, 0.015555, 0.019193, 0.019386, 0.017755, 0.022344
#*# 	-0.050772, -0.049583, -0.049508, -0.050194, -0.045261, -0.039057, -0.042628, -0.035825, -0.028177, -0.033727, -0.011256, -0.021792, -0.009319, -0.012195, -0.016220, -0.012075, -0.015917, -0.007968, -0.005377, 0.001793, 0.000787, 0.004726, 0.011636, 0.017900, 0.024738, 0.024704, 0.020432, 0.020176, 0.017169, 0.014577
#*# 	-0.050034, -0.047592, -0.047315, -0.048383, -0.050600, -0.044835, -0.046156, -0.035943, -0.026554, -0.030971, -0.012212, -0.017304, -0.014612, -0.003358, -0.013991, -0.006049, -0.009569, -0.006561, -0.007687, -0.003165, 0.002585, 0.004902, 0.015840, 0.018779, 0.023718, 0.024063, 0.024279, 0.023058, 0.023880, 0.015991
#*# 	-0.051328, -0.048374, -0.047052, -0.052024, -0.048821, -0.042427, -0.040916, -0.036345, -0.026738, -0.029164, -0.020761, -0.012264, -0.020628, -0.001728, -0.015486, -0.009765, -0.015848, -0.013529, -0.010950, -0.004954, 0.011044, 0.012407, 0.016712, 0.018971, 0.023014, 0.024582, 0.027734, 0.026298, 0.022287, 0.015742
#*# 	-0.047271, -0.044110, -0.043064, -0.050947, -0.050839, -0.045480, -0.042030, -0.040094, -0.030891, -0.017430, -0.029907, -0.005320, -0.019835, 0.000320, -0.012108, -0.008166, -0.007990, -0.006349, -0.005094, -0.002192, 0.007911, 0.007090, 0.012519, 0.020861, 0.024062, 0.025293, 0.026081, 0.025422, 0.023782, 0.021766
#*# 	-0.054473, -0.052379, -0.049120, -0.052649, -0.049113, -0.043234, -0.040295, -0.033924, -0.037464, -0.012669, -0.035545, -0.006711, -0.021734, -0.008841, -0.012674, -0.010833, -0.010986, -0.011190, -0.006599, -0.004927, 0.006973, 0.013896, 0.013867, 0.023199, 0.022409, 0.023685, 0.024122, 0.023775, 0.023307, 0.018174
#*# 	-0.053062, -0.048562, -0.045261, -0.054301, -0.053661, -0.047777, -0.043003, -0.033159, -0.039471, -0.012856, -0.034287, -0.013435, -0.019319, -0.012176, -0.004825, -0.004710, -0.006074, -0.012062, -0.006333, -0.006134, 0.000132, 0.006843, 0.006619, 0.017365, 0.019912, 0.021593, 0.023870, 0.023271, 0.023221, 0.019217
#*# 	-0.055255, -0.053343, -0.050596, -0.056071, -0.052719, -0.044367, -0.047806, -0.034471, -0.037659, -0.021293, -0.033356, -0.023033, -0.023042, -0.016888, -0.008650, -0.009686, -0.006650, -0.009315, -0.008559, -0.003488, -0.000990, 0.007045, 0.014011, 0.017893, 0.021543, 0.019781, 0.019838, 0.019822, 0.019448, 0.015545
#*# 	-0.052907, -0.052583, -0.048897, -0.056824, -0.056594, -0.044478, -0.048883, -0.038563, -0.034513, -0.036192, -0.028654, -0.027995, -0.017303, -0.014741, -0.007861, -0.008043, -0.004186, -0.007582, -0.003989, -0.004653, 0.005984, 0.009529, 0.016695, 0.017287, 0.020637, 0.021005, 0.020416, 0.023139, 0.023144, 0.018245
#*# 	-0.050468, -0.051174, -0.048983, -0.053858, -0.052029, -0.041411, -0.047212, -0.035781, -0.030760, -0.039744, -0.017686, -0.025886, -0.012390, -0.011795, -0.005543, -0.005004, -0.002388, -0.007010, 0.004560, -0.002373, 0.013069, 0.012740, 0.017468, 0.018565, 0.023297, 0.024490, 0.023140, 0.023214, 0.021161, 0.018670
#*# 	-0.051709, -0.052035, -0.047156, -0.051228, -0.049259, -0.040669, -0.049088, -0.031407, -0.031723, -0.036605, -0.007746, -0.024932, -0.005518, -0.013577, -0.009367, -0.004196, 0.000040, -0.005020, 0.007700, -0.002215, 0.013709, 0.013976, 0.017803, 0.026049, 0.025376, 0.024730, 0.023702, 0.027572, 0.026288, 0.019779
#*# 	-0.052055, -0.050351, -0.047786, -0.053904, -0.050504, -0.043149, -0.048979, -0.032439, -0.035325, -0.032251, -0.013982, -0.028659, -0.007793, -0.010017, -0.005512, -0.005677, -0.000002, -0.007035, 0.005884, -0.000402, 0.013954, 0.013706, 0.013923, 0.024669, 0.022355, 0.028202, 0.024637, 0.027741, 0.025004, 0.023165
#*# 	-0.051990, -0.053448, -0.049106, -0.056963, -0.050255, -0.045416, -0.046572, -0.028591, -0.039446, -0.027395, -0.022407, -0.028414, -0.008516, -0.012855, -0.004237, -0.007541, -0.001460, -0.004668, 0.006455, 0.002060, 0.010458, 0.015526, 0.014508, 0.024847, 0.022220, 0.030638, 0.026980, 0.030153, 0.027096, 0.025527
#*# 	-0.053398, -0.052792, -0.049531, -0.057145, -0.053484, -0.041398, -0.046198, -0.027923, -0.045381, -0.024758, -0.029037, -0.026170, -0.012626, -0.015481, -0.004388, -0.009212, -0.000327, -0.002076, 0.002464, 0.004455, 0.005473, 0.016773, 0.013009, 0.023681, 0.022430, 0.027960, 0.023106, 0.031416, 0.028408, 0.027704
#*# 	-0.056331, -0.054523, -0.053959, -0.058514, -0.057147, -0.037880, -0.047070, -0.025518, -0.044478, -0.024445, -0.033905, -0.026019, -0.015778, -0.018790, -0.005481, -0.006964, -0.000762, 0.002059, 0.000219, 0.006822, 0.003343, 0.018401, 0.020011, 0.023444, 0.026271, 0.029014, 0.026020, 0.028665, 0.026581, 0.027601
#*# 	-0.057898, -0.057743, -0.053529, -0.052346, -0.058262, -0.035778, -0.050253, -0.032895, -0.041816, -0.031371, -0.034924, -0.029582, -0.015953, -0.015572, -0.005934, -0.002122, -0.002030, 0.006183, -0.002556, 0.015173, 0.003869, 0.022187, 0.019188, 0.021660, 0.025346, 0.026258, 0.024595, 0.030184, 0.029514, 0.029625
#*# 	-0.059887, -0.059949, -0.057366, -0.052624, -0.062550, -0.040092, -0.047875, -0.041942, -0.037487, -0.043216, -0.036998, -0.032270, -0.021729, -0.017727, -0.010107, -0.000737, -0.007349, 0.007828, -0.001767, 0.018319, 0.004737, 0.018523, 0.015520, 0.017721, 0.023929, 0.028400, 0.026153, 0.030854, 0.029619, 0.028085
#*# 	-0.061497, -0.060893, -0.058725, -0.054294, -0.064328, -0.047960, -0.043249, -0.052918, -0.034739, -0.049931, -0.036667, -0.031925, -0.027045, -0.015678, -0.012568, -0.004881, -0.009314, 0.004547, -0.004942, 0.014310, 0.004788, 0.015819, 0.018640, 0.016561, 0.023826, 0.024992, 0.024696, 0.029483, 0.027128, 0.027433
#*# 	-0.062193, -0.061239, -0.058150, -0.056568, -0.061063, -0.055688, -0.042205, -0.056011, -0.034869, -0.051080, -0.037496, -0.036689, -0.030720, -0.019053, -0.009523, -0.007739, -0.009496, 0.000758, -0.008239, 0.006564, 0.001517, 0.010684, 0.014865, 0.018465, 0.024067, 0.021944, 0.025413, 0.027535, 0.025236, 0.027275
#*# 	-0.058113, -0.059926, -0.055471, -0.056623, -0.057239, -0.058408, -0.042503, -0.051571, -0.032765, -0.044709, -0.034635, -0.037782, -0.029118, -0.022004, -0.013230, -0.006423, -0.007128, -0.000354, -0.009588, 0.000711, -0.000404, 0.007558, 0.014558, 0.018640, 0.022361, 0.019979, 0.025537, 0.022962, 0.025687, 0.025634
#*# 	-0.057096, -0.056662, -0.053768, -0.057971, -0.055574, -0.060882, -0.048159, -0.048420, -0.039257, -0.038879, -0.033221, -0.032910, -0.028078, -0.019681, -0.016894, -0.006324, -0.006414, -0.000001, -0.007482, 0.001147, -0.000144, 0.004001, 0.013273, 0.017696, 0.023140, 0.020684, 0.025205, 0.019394, 0.025981, 0.026258
#*# 	-0.056991, -0.057497, -0.051372, -0.058454, -0.053315, -0.061595, -0.051929, -0.047149, -0.042049, -0.033160, -0.033561, -0.026902, -0.027616, -0.020937, -0.017511, -0.005785, -0.009462, -0.001411, -0.006597, -0.000975, -0.000344, 0.001795, 0.011816, 0.013850, 0.020644, 0.022699, 0.024551, 0.021315, 0.026282, 0.023836
#*# 	-0.058519, -0.056329, -0.050475, -0.056834, -0.052178, -0.058312, -0.051614, -0.048766, -0.041348, -0.032288, -0.032462, -0.023528, -0.024853, -0.018838, -0.016423, -0.008173, -0.010437, -0.008807, -0.005420, -0.004650, -0.000825, 0.000889, 0.010350, 0.011668, 0.022326, 0.023528, 0.022339, 0.023184, 0.026686, 0.023273
#*# 	-0.060517, -0.057687, -0.053594, -0.059902, -0.056014, -0.057430, -0.053337, -0.049513, -0.042141, -0.035397, -0.032427, -0.025015, -0.023238, -0.018898, -0.019195, -0.011122, -0.010761, -0.017273, -0.006089, -0.015460, -0.000917, 0.000126, 0.011793, 0.011363, 0.021452, 0.023361, 0.023132, 0.023541, 0.025157, 0.022947
#*# 	-0.060594, -0.056229, -0.054266, -0.058189, -0.058531, -0.055650, -0.057816, -0.050396, -0.046102, -0.039271, -0.032966, -0.025885, -0.021600, -0.017181, -0.019889, -0.011792, -0.013278, -0.017232, -0.009590, -0.018148, -0.003758, -0.001426, 0.011423, 0.014718, 0.019935, 0.020945, 0.023149, 0.023149, 0.024449, 0.023831
#*# 	-0.062379, -0.058317, -0.057240, -0.059740, -0.061672, -0.057773, -0.061950, -0.053624, -0.052984, -0.043828, -0.039227, -0.031475, -0.025053, -0.020108, -0.022062, -0.017641, -0.016180, -0.020014, -0.015324, -0.014524, -0.010524, -0.004118, 0.001813, 0.015853, 0.014359, 0.020512, 0.020683, 0.021425, 0.022785, 0.021030
#*# 	-0.062916, -0.059507, -0.058384, -0.060789, -0.062972, -0.060691, -0.064326, -0.058641, -0.058393, -0.049656, -0.046764, -0.035519, -0.030683, -0.022015, -0.025447, -0.020688, -0.021960, -0.022509, -0.018465, -0.012364, -0.012365, -0.002051, -0.007073, 0.011761, 0.006748, 0.019977, 0.018026, 0.019407, 0.020400, 0.018777
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 200.0
#*# min_y = 34.0
#*# max_y = 180.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.900
#*# pid_ki = 1.010
#*# pid_kd = 108.160
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 51.782
#*# pid_ki = 1.995
#*# pid_kd = 335.938
