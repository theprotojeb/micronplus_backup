[include mainsail.cfg]
# This file contains common pin mappings for the BIGTREETECH Manta M8P V1.1
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication.

# See docs/Config_Reference.md for a description of parameters.
[include mcu_definitions/mantaM8P.cfg]
[include mcu_definitions/ebb36.cfg]
[include kinematics.cfg]
[include hardware/xy.cfg]
[include hardware/z.cfg]
[include hardware/temperature_sensors/ebb36_temp.cfg]
[include hardware/temperature_sensors/mcu_temp.cfg]
[include hardware/temperature_sensors/rpi_temp.cfg]
[include hardware/probe/qgl.cfg]
[include spoolman.cfg]
[include cartographer.cfg]
[include moonraker_obico_macros.cfg]

[force_move]
enable_force_move: true

[heater_bed]
heater_pin: PB5
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA0
##	Adjust Max Power so your heater doesn't warp your bed
max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[extruder]
step_pin: ebb36: PD0
dir_pin: !ebb36: PD1
enable_pin: !ebb36: PD2
microsteps: 16
rotation_distance: 22.6789511
gear_ratio: 50:10
nozzle_diameter: 0.400
filament_diameter: 1.75
pressure_advance: 0.05
pressure_advance_smooth_time: 0.040
heater_pin: ebb36: PB13
sensor_pin: ebb36: PA3
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: -250
max_temp: 250

## EXTRUDER MOTOR
[tmc2209 extruder]
uart_pin: ebb36: PA15
run_current: 0.650
stealthchop_threshold: 999999

[exclude_object]

[homing_override]
gcode:
    
    {% if not 'Z' in params and not 'Y' in params and 'X' in params %}
    _HOME_X
    {% elif not 'Z' in params and not 'X' in params and 'Y' in params %}
    _HOME_Y
    {% elif not 'Z' in params and 'X' in params and 'Y' in params %}
    _HOME_Y
    _HOME_X
    {% elif 'Z' in params and not 'X' in params and not 'Y' in params %}
    G28 Z
    G0 Z10
    {% else %}
    SET_KINEMATIC_POSITION HOMED_AXIS=Z0
    G0 Z10
    _HOME_Y
    _HOME_X
    G0 X85 Y85
    G28 Z
    G0 Z10
    
    {% endif %}
    
    
[gcode_macro _HOME_X]
gcode:
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 X F800
    # Move away
    G1 X10 F2000
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    
[gcode_macro _HOME_Y]
gcode:
    # Set current for sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 Y F800
    # Move away
    G1 Y10 F2000
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 2250
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.090
#*#
#*# [scanner model default]
#*# model_coef = 1.3599214991681838,
#*# 	1.800994868158209,
#*# 	0.7368526251356845,
#*# 	0.1839513625820262,
#*# 	0.5160581150370068,
#*# 	1.063833589819737,
#*# 	-0.4756891851867809,
#*# 	-1.2835206265579566,
#*# 	0.4113163441178701,
#*# 	0.6851381492479492
#*# model_domain = 3.145304241094606e-07,3.2989716930707365e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 43.451526
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.451261, -0.038244, -0.042622, -0.048056, -0.040553, -0.038377, -0.017099, 0.005698, -0.012514, -0.020344, -0.006486, -0.004263, -0.003275, -0.010166, -0.158948
#*# 	  -0.435976, -0.037219, -0.035410, -0.038348, -0.032022, -0.024179, -0.009213, 0.005789, -0.008846, -0.014239, -0.006809, 0.001003, -0.001142, -0.012568, -0.163237
#*# 	  -0.420038, -0.029808, -0.029079, -0.032924, -0.023903, -0.021790, -0.009700, -0.004109, -0.006623, -0.007240, -0.004652, 0.004874, 0.000439, -0.003798, -0.159870
#*# 	  -0.407723, -0.027382, -0.023174, -0.028833, -0.021623, -0.024423, -0.017064, -0.007156, -0.011386, -0.004767, 0.003900, 0.012783, 0.005314, -0.006558, -0.164444
#*# 	  -0.403105, -0.030859, -0.024840, -0.030455, -0.015539, -0.003286, -0.010106, -0.007099, -0.007278, -0.008734, 0.001368, 0.010101, 0.007073, -0.000792, -0.165699
#*# 	  -0.394149, -0.034292, -0.025366, -0.033916, -0.022270, -0.013455, -0.012373, -0.005656, -0.003717, -0.004016, 0.003364, 0.005371, 0.000990, -0.001686, -0.168893
#*# 	  -0.384673, -0.031513, -0.024155, -0.032287, -0.026081, -0.023644, -0.005727, -0.001335, -0.005537, -0.007458, 0.005173, 0.009616, 0.005870, 0.001449, -0.169627
#*# 	  -0.376743, -0.031371, -0.024951, -0.032013, -0.017332, -0.015431, -0.001135, -0.001675, -0.005011, -0.004348, 0.000598, 0.007615, 0.007538, 0.003671, -0.168021
#*# 	  -0.373936, -0.036656, -0.029652, -0.036136, -0.014323, -0.015988, -0.007990, -0.004365, -0.000895, 0.005476, 0.008828, 0.009756, 0.005023, 0.005400, -0.168454
#*# 	  -0.365630, -0.037658, -0.033641, -0.046136, -0.035748, -0.035082, -0.021951, -0.007252, -0.007063, 0.013561, 0.006126, 0.009796, 0.010108, 0.006310, -0.170902
#*# 	  -0.360651, -0.036567, -0.029879, -0.040542, -0.033248, -0.030836, -0.026323, -0.006998, -0.000143, -0.003446, -0.001699, 0.009114, 0.006615, 0.002735, -0.173081
#*# 	  -0.353684, -0.033425, -0.024160, -0.029972, -0.029981, -0.014222, -0.017830, -0.009392, -0.001223, -0.004877, -0.003178, 0.011204, 0.003439, -0.001657, -0.175453
#*# 	  -0.353923, -0.037664, -0.029229, -0.035487, -0.029153, -0.022995, -0.015496, -0.013334, -0.011924, -0.020558, 0.001996, 0.009845, 0.005043, 0.001947, -0.178624
#*# 	  -0.351015, -0.041943, -0.035568, -0.037083, -0.037214, -0.036305, -0.021211, -0.015581, -0.019548, -0.011242, -0.004217, -0.002361, 0.003335, 0.000657, -0.183362
#*# 	  -0.353632, -0.045362, -0.040609, -0.040259, -0.040029, -0.040687, -0.030951, -0.022689, -0.023511, -0.019527, -0.009722, 0.008059, 0.010578, -0.001710, -0.193347
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 0.0
#*# max_x = 172.0
#*# min_y = 24.0
#*# max_y = 160.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 21.015
#*# pid_ki = 1.015
#*# pid_kd = 108.754
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 56.190
#*# pid_ki = 2.638
#*# pid_kd = 299.214
