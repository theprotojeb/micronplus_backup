[include mainsail.cfg]
# This file contains common pin mappings for the BIGTREETECH Manta M8P V1.1
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication.

# See docs/Config_Reference.md for a description of parameters.
[include mcu_definitions/mantaM8P.cfg]
[include mcu_definitions/ebb36.cfg]
[include kinematics.cfg]
[include hardware/xy.cfg]
[include hardware/z.cfg]
[include hardware/extruder.cfg]
[include hardware/heater_bed.cfg]
[include hardware/temperature_sensors/ebb36_temp.cfg]
[include hardware/temperature_sensors/mcu_temp.cfg]
[include hardware/temperature_sensors/rpi_temp.cfg]
[include hardware/probe/qgl.cfg]
[include spoolman.cfg]
[include cartographer.cfg]

[force_move]
enable_force_move: true

[homing_override]
gcode:

  {% if not 'Z' in params and not 'Y' in params and 'X' in params %}
  _HOME_X
  G4 P1000
  _HOME_X
  {% elif not 'Z' in params and not 'X' in params and 'Y' in params %}
  _HOME_Y
  G4 P1000
  _HOME_Y
  {% elif not 'Z' in params and 'X' in params and 'Y' in params %}
  _HOME_Y
  G4 P1000
  _HOME_Y
  _HOME_X
  G4 P1000
  _HOME_X
  {% elif 'Z' in params and not 'X' in params and not 'Y' in params %}
  G28 Z
  G0 Z10
  {% else %}
  SET_KINEMATIC_POSITION HOMED_AXIS=Z0
  G0 Z10
  SET_KINEMATIC_POSITION CLEAR_HOMED=Z
  _HOME_Y
  G4 P1000
  _HOME_Y
  _HOME_X
  G4 P1000
  _HOME_X
  G0 X95 Y95
  G28 Z
  G0 Z10

  {% endif %} 


[gcode_macro _HOME_X]
gcode:
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 X F1200
    # Move away
    G91
    G1 X10 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    
[gcode_macro _HOME_Y]
gcode:
    # Set current for sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 Y F1200
    # Move away
    G91
    G1 Y10 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [scanner]
#*# mode = touch
#*#
#*# [scanner model default]
#*# model_coef = 1.525655903632888,
#*# 	1.7948450800481244,
#*# 	0.7051435344273781,
#*# 	0.40159627849029367,
#*# 	0.49453663919056695,
#*# 	0.11937565953471407,
#*# 	-0.2742073971199309,
#*# 	-0.1571390425533812,
#*# 	0.09577401982704113,
#*# 	0.2965964106937697
#*# model_domain = 3.172883330894801e-07,3.3008388270039953e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 27.285727
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.056224, -0.049305, -0.052550, -0.044405, -0.038214, -0.035864, -0.035463, -0.016899, -0.018496, -0.021558, 0.003002, -0.007942, -0.008521, -0.008604, -0.011802, -0.012488, -0.013247, -0.005233, -0.002336, -0.003517, 0.002119, 0.005267, 0.012464, 0.016379, 0.016005, 0.017107, 0.017124, 0.016310, 0.013397, 0.010190
#*# 	  -0.051677, -0.045869, -0.051121, -0.039752, -0.033333, -0.027574, -0.032170, -0.015708, -0.013255, -0.019172, -0.001742, -0.003372, -0.007120, -0.006273, -0.013609, -0.011860, -0.006819, -0.004146, -0.001862, -0.003778, 0.005248, 0.010173, 0.014200, 0.016312, 0.015034, 0.017868, 0.017407, 0.020079, 0.016067, 0.013828
#*# 	  -0.045266, -0.041150, -0.041197, -0.036395, -0.033071, -0.027140, -0.030778, -0.015171, -0.008051, -0.019506, -0.005602, -0.006285, -0.013439, -0.005805, -0.007751, -0.004859, -0.004597, -0.004174, 0.003317, -0.000595, 0.004912, 0.012641, 0.014756, 0.018481, 0.021501, 0.019773, 0.018678, 0.019247, 0.017476, 0.017653
#*# 	  -0.044951, -0.038481, -0.037883, -0.031727, -0.030245, -0.020960, -0.022843, -0.015328, -0.004406, -0.024631, -0.010316, -0.005994, -0.008780, -0.004251, -0.007208, -0.006420, -0.003915, -0.004250, 0.003322, 0.005640, 0.009331, 0.016466, 0.016298, 0.018611, 0.023097, 0.021779, 0.022320, 0.022154, 0.020848, 0.022541
#*# 	  -0.042020, -0.036418, -0.030667, -0.029358, -0.031307, -0.011847, -0.019201, -0.019075, 0.000949, -0.015302, -0.011205, -0.006386, -0.011845, -0.007908, -0.007427, -0.006058, 0.002407, 0.003304, 0.004620, 0.007305, 0.011454, 0.017825, 0.023135, 0.025024, 0.026357, 0.025747, 0.026455, 0.024570, 0.023258, 0.020431
#*# 	  -0.040133, -0.035845, -0.030968, -0.024899, -0.031679, -0.008904, -0.012763, -0.023427, 0.001117, -0.009616, -0.011424, -0.006320, -0.013483, -0.006399, -0.007332, -0.004620, 0.000919, 0.007715, 0.006858, 0.011136, 0.017541, 0.022885, 0.024818, 0.027542, 0.028727, 0.027135, 0.028638, 0.027690, 0.024996, 0.020977
#*# 	  -0.037086, -0.036198, -0.033383, -0.019487, -0.033330, -0.015294, -0.005784, -0.025740, 0.000050, -0.003217, -0.010212, -0.005593, -0.011608, -0.006211, -0.006563, -0.001498, 0.001515, 0.009315, 0.011721, 0.011645, 0.020019, 0.022868, 0.026483, 0.028514, 0.030017, 0.031512, 0.030373, 0.030368, 0.027312, 0.024430
#*# 	  -0.036962, -0.035476, -0.039167, -0.016039, -0.027835, -0.024220, -0.001397, -0.021991, -0.005163, -0.003768, -0.008932, -0.004136, -0.008261, -0.003400, -0.006191, -0.000820, 0.002450, 0.008130, 0.014648, 0.016758, 0.019989, 0.023897, 0.025971, 0.029024, 0.030879, 0.032030, 0.032756, 0.031167, 0.028143, 0.027224
#*# 	  -0.036765, -0.031999, -0.043191, -0.015814, -0.018594, -0.031124, -0.004634, -0.015300, -0.011961, -0.004598, -0.006521, -0.003850, -0.007156, -0.000580, -0.003855, 0.001903, 0.004804, 0.004127, 0.016417, 0.017777, 0.016710, 0.022597, 0.029027, 0.029234, 0.030565, 0.031891, 0.031196, 0.031053, 0.028909, 0.026900
#*# 	  -0.038868, -0.026283, -0.039871, -0.019604, -0.012680, -0.029315, -0.009905, -0.012690, -0.015403, -0.005373, -0.003053, -0.001019, -0.002625, 0.002340, -0.002976, 0.001888, 0.007550, 0.005205, 0.014675, 0.019036, 0.017072, 0.021346, 0.027978, 0.027624, 0.029532, 0.030280, 0.029457, 0.029293, 0.028986, 0.027007
#*# 	  -0.042531, -0.030360, -0.036852, -0.028356, -0.019608, -0.029069, -0.017721, -0.014999, -0.017986, -0.007838, -0.001986, -0.002932, -0.003115, 0.002219, -0.000076, 0.002242, 0.008768, 0.008789, 0.011001, 0.016266, 0.020374, 0.022416, 0.027316, 0.027243, 0.028526, 0.028966, 0.027127, 0.027061, 0.027130, 0.024321
#*# 	  -0.046202, -0.035639, -0.031685, -0.033528, -0.028320, -0.022589, -0.023397, -0.016702, -0.014569, -0.007355, -0.001596, 0.000774, 0.002169, 0.004063, 0.004755, 0.007100, 0.005825, 0.012265, 0.017732, 0.020417, 0.024223, 0.024040, 0.027579, 0.028654, 0.030198, 0.030411, 0.027008, 0.026491, 0.026867, 0.025053
#*# 	  -0.044672, -0.034526, -0.024425, -0.036211, -0.029010, -0.014241, -0.021178, -0.010591, -0.007670, -0.003941, 0.000572, 0.001374, 0.006314, 0.005104, 0.006985, 0.016415, 0.008941, 0.017664, 0.023941, 0.023386, 0.028368, 0.029353, 0.031354, 0.030585, 0.031762, 0.031131, 0.029417, 0.028902, 0.028371, 0.026552
#*# 	  -0.043257, -0.029914, -0.021396, -0.039150, -0.023009, -0.007731, -0.019725, -0.005884, -0.004449, -0.002422, 0.000366, 0.002491, 0.008634, 0.006946, 0.006853, 0.017540, 0.009263, 0.019806, 0.029175, 0.027146, 0.028743, 0.031277, 0.031591, 0.031186, 0.033929, 0.034096, 0.031835, 0.032220, 0.030163, 0.029956
#*# 	  -0.043380, -0.028366, -0.026823, -0.033774, -0.019260, -0.009180, -0.023450, -0.001742, -0.004165, -0.002385, 0.001464, -0.000834, 0.008840, 0.004673, 0.006432, 0.019214, 0.012863, 0.018951, 0.027237, 0.025990, 0.026448, 0.033112, 0.034129, 0.031823, 0.036409, 0.035341, 0.033517, 0.035576, 0.033370, 0.031947
#*# 	  -0.040534, -0.026906, -0.036336, -0.028095, -0.018467, -0.017161, -0.023688, -0.001151, -0.006835, -0.001247, 0.003431, -0.001257, 0.008475, 0.007978, 0.008581, 0.016429, 0.015107, 0.017820, 0.026408, 0.027138, 0.025229, 0.033097, 0.032672, 0.032657, 0.038711, 0.037533, 0.035823, 0.038164, 0.035936, 0.035761
#*# 	  -0.037343, -0.022732, -0.042013, -0.025068, -0.019543, -0.022512, -0.023914, -0.000825, -0.012278, -0.002920, 0.003751, -0.002768, 0.007756, 0.007316, 0.009271, 0.015434, 0.017880, 0.014808, 0.024502, 0.029471, 0.025666, 0.032388, 0.034748, 0.033342, 0.038209, 0.035691, 0.035695, 0.041984, 0.038393, 0.038000
#*# 	  -0.042004, -0.023198, -0.041546, -0.027104, -0.021988, -0.022930, -0.021658, -0.005842, -0.015758, -0.006133, 0.001687, -0.000023, 0.006707, 0.008513, 0.011613, 0.011480, 0.019600, 0.012719, 0.021529, 0.033146, 0.026446, 0.029594, 0.033821, 0.036410, 0.038038, 0.034784, 0.036380, 0.041706, 0.040855, 0.040164
#*# 	  -0.045043, -0.026475, -0.034436, -0.030235, -0.024560, -0.026912, -0.023809, -0.009570, -0.010163, -0.006496, -0.000674, 0.003737, 0.009112, 0.007285, 0.017823, 0.008901, 0.025414, 0.016628, 0.022176, 0.033171, 0.030132, 0.030230, 0.035987, 0.037992, 0.039218, 0.037128, 0.038759, 0.041412, 0.040766, 0.041516
#*# 	  -0.044832, -0.037159, -0.029292, -0.034320, -0.033964, -0.028106, -0.024758, -0.016887, -0.008043, -0.006001, -0.002332, 0.005141, 0.010283, 0.001709, 0.017900, 0.007825, 0.026872, 0.018586, 0.020286, 0.030858, 0.029946, 0.029511, 0.033376, 0.038133, 0.038816, 0.036440, 0.039199, 0.041154, 0.040469, 0.041619
#*# 	  -0.042541, -0.046164, -0.029724, -0.034991, -0.042533, -0.027799, -0.022372, -0.022974, -0.010770, -0.005837, -0.002600, 0.002373, 0.005966, -0.002326, 0.016330, 0.006276, 0.022957, 0.018250, 0.019001, 0.025874, 0.027533, 0.029700, 0.030501, 0.038446, 0.038520, 0.035715, 0.041171, 0.041105, 0.039545, 0.040199
#*# 	  -0.039740, -0.048820, -0.031465, -0.031571, -0.044519, -0.027929, -0.022984, -0.026243, -0.014841, -0.009028, -0.002654, -0.000115, 0.001054, 0.001153, 0.010213, 0.002640, 0.014824, 0.011705, 0.017326, 0.020653, 0.024130, 0.029169, 0.030389, 0.037187, 0.034274, 0.034186, 0.040170, 0.037240, 0.038086, 0.039624
#*# 	  -0.037741, -0.045546, -0.031825, -0.028305, -0.038947, -0.026207, -0.028787, -0.026026, -0.013557, -0.011149, -0.002937, 0.003007, -0.000478, 0.006112, 0.009259, 0.001587, 0.013449, 0.007899, 0.016758, 0.019654, 0.023979, 0.030295, 0.031791, 0.034869, 0.031286, 0.035406, 0.037918, 0.034762, 0.037199, 0.037977
#*# 	  -0.041559, -0.042483, -0.034412, -0.029403, -0.032030, -0.023775, -0.024686, -0.023555, -0.013843, -0.010024, -0.007777, 0.003410, -0.001788, 0.007747, 0.010927, 0.003262, 0.010059, 0.005479, 0.015535, 0.016850, 0.022131, 0.025654, 0.030742, 0.034840, 0.030635, 0.034543, 0.032552, 0.033243, 0.038706, 0.038560
#*# 	  -0.044389, -0.042232, -0.038073, -0.029750, -0.027434, -0.026046, -0.019628, -0.021162, -0.014768, -0.011943, -0.009438, 0.003664, -0.003686, 0.006248, 0.007687, 0.003182, 0.010865, 0.007191, 0.013980, 0.013132, 0.020774, 0.023988, 0.029024, 0.030406, 0.033090, 0.036995, 0.030957, 0.034914, 0.037006, 0.035529
#*# 	  -0.043778, -0.041232, -0.037621, -0.028835, -0.022655, -0.024643, -0.017992, -0.018267, -0.013255, -0.010695, -0.007676, 0.003480, -0.006781, 0.003313, -0.000761, 0.003840, 0.009917, 0.004866, 0.011810, 0.012337, 0.019539, 0.021200, 0.029060, 0.031715, 0.034072, 0.037612, 0.030364, 0.036488, 0.036323, 0.034014
#*# 	  -0.044843, -0.042838, -0.039653, -0.029651, -0.028493, -0.024598, -0.016625, -0.016915, -0.011359, -0.010831, -0.011144, -0.001473, -0.005464, 0.000742, -0.008209, 0.003114, -0.000930, 0.001375, 0.010965, 0.010690, 0.021022, 0.019816, 0.030458, 0.031061, 0.032641, 0.035786, 0.030912, 0.036454, 0.034874, 0.033438
#*# 	  -0.048128, -0.042206, -0.042339, -0.032065, -0.032853, -0.024426, -0.015414, -0.016147, -0.009575, -0.011007, -0.010849, -0.003921, -0.005448, -0.002389, -0.007052, 0.001726, -0.008100, 0.002125, 0.005230, 0.009589, 0.022233, 0.021803, 0.031023, 0.030501, 0.031623, 0.036107, 0.031113, 0.034957, 0.034761, 0.034315
#*# 	  -0.052143, -0.045202, -0.047443, -0.037456, -0.035431, -0.029754, -0.022415, -0.019632, -0.011780, -0.011110, -0.013343, -0.008552, -0.008479, -0.005821, -0.008716, -0.004272, -0.006896, 0.003720, -0.003775, 0.007669, 0.014449, 0.018288, 0.030702, 0.024329, 0.030557, 0.034197, 0.029592, 0.033704, 0.033173, 0.032146
#*# 	  -0.053855, -0.048634, -0.051527, -0.043184, -0.039596, -0.035718, -0.026365, -0.023520, -0.015784, -0.013008, -0.015747, -0.012289, -0.010952, -0.011583, -0.010702, -0.007015, -0.004020, 0.002000, -0.003888, 0.008943, 0.005519, 0.015187, 0.023132, 0.019326, 0.031325, 0.030839, 0.027227, 0.031183, 0.030641, 0.030294
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 59.0
#*# max_x = 200.0
#*# min_y = 34.0
#*# max_y = 180.0
