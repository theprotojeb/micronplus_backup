[include mainsail.cfg]
# This file contains common pin mappings for the BIGTREETECH Manta M8P V1.1
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication.

# See docs/Config_Reference.md for a description of parameters.
[include mcu_definitions/mantaM8P.cfg]
[include mcu_definitions/ebb36.cfg]
[include kinematics.cfg]
[include hardware/xy.cfg]
[include hardware/z.cfg]
[include hardware/temperature_sensors/ebb36_temp.cfg]
[include hardware/temperature_sensors/mcu_temp.cfg]
[include hardware/temperature_sensors/rpi_temp.cfg]
[include hardware/probe/qgl.cfg]
[include spoolman.cfg]
[include cartographer.cfg]

[force_move]
enable_force_move: true

[heater_bed]
heater_pin: PB5
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA0
##	Adjust Max Power so your heater doesn't warp your bed
max_power: 1.0
min_temp: 0
max_temp: 120
control: pid
pid_kp: 58.437
pid_ki: 2.347
pid_kd: 363.769

[extruder]
step_pin: ebb36: PD0
dir_pin: !ebb36: PD1
enable_pin: !ebb36: PD2
microsteps: 16
rotation_distance: 33.500
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: ebb36: PB13
sensor_pin: ebb36: PA3
sensor_type: EPCOS 100K B57560G104F
control: pid
pid_Kp: 21.527
pid_Ki: 1.063
pid_Kd: 108.982
min_temp: -250
max_temp: 250

## EXTRUDER MOTOR
[tmc2209 extruder]
uart_pin: ebb36: PA15
run_current: 0.650
stealthchop_threshold: 999999

[homing_override]
gcode:

  {% if not 'Z' in params and not 'Y' in params and 'X' in params %}
  _HOME_X
  G4 P1000
  _HOME_X
  {% elif not 'Z' in params and not 'X' in params and 'Y' in params %}
  _HOME_Y
  G4 P1000
  _HOME_Y
  {% elif not 'Z' in params and 'X' in params and 'Y' in params %}
  _HOME_Y
  G4 P1000
  _HOME_Y
  _HOME_X
  G4 P1000
  _HOME_X
  {% elif 'Z' in params and not 'X' in params and not 'Y' in params %}
  G28 Z
  G0 Z10
  {% else %}
  SET_KINEMATIC_POSITION HOMED_AXIS=Z0
  G0 Z10
  SET_KINEMATIC_POSITION CLEAR_HOMED=Z
  _HOME_Y
  G4 P1000
  _HOME_Y
  _HOME_X
  G4 P1000
  _HOME_X
  G0 X95 Y95
  G28 Z
  G0 Z10

  {% endif %} 


[gcode_macro _HOME_X]
gcode:
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 X F1200
    # Move away
    G91
    G1 X10 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    
[gcode_macro _HOME_Y]
gcode:
    # Set current for sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 Y F1200
    # Move away
    G91
    G1 Y10 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [scanner]
#*# mode = touch
#*#
#*# [scanner model default]
#*# model_coef = 1.525655903632888,
#*# 	1.7948450800481244,
#*# 	0.7051435344273781,
#*# 	0.40159627849029367,
#*# 	0.49453663919056695,
#*# 	0.11937565953471407,
#*# 	-0.2742073971199309,
#*# 	-0.1571390425533812,
#*# 	0.09577401982704113,
#*# 	0.2965964106937697
#*# model_domain = 3.172883330894801e-07,3.3008388270039953e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 27.285727
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.065541, -0.056840, -0.057245, -0.057249, -0.056678, -0.052580, -0.054207, -0.042898, -0.046127, -0.037241, -0.034646, -0.032429, -0.012242, -0.023688, 0.000249, -0.009941, -0.009848, -0.014347, -0.012011, -0.011177, -0.001879, -0.002791, 0.004783, 0.006464, 0.011056, 0.012171, 0.014522, 0.012464, 0.010515, 0.006510
#*# 	  -0.058149, -0.050822, -0.052330, -0.056663, -0.055580, -0.050926, -0.049042, -0.045182, -0.042728, -0.032707, -0.028862, -0.030122, -0.009403, -0.020143, -0.001511, -0.008223, -0.006809, -0.005147, -0.008100, -0.009105, -0.002019, -0.002760, 0.005980, 0.011896, 0.015287, 0.015675, 0.014378, 0.014840, 0.013764, 0.011228
#*# 	  -0.054794, -0.052212, -0.052838, -0.054391, -0.053028, -0.047120, -0.046718, -0.038306, -0.038524, -0.031043, -0.023990, -0.025698, -0.004683, -0.016755, -0.005417, -0.007685, -0.008328, -0.007934, -0.005112, -0.006423, -0.000735, -0.002098, 0.005630, 0.013333, 0.017103, 0.019682, 0.018187, 0.015163, 0.014794, 0.016299
#*# 	  -0.054362, -0.049168, -0.049796, -0.050083, -0.048745, -0.040135, -0.039808, -0.034635, -0.030917, -0.033689, -0.019755, -0.024281, -0.006392, -0.013899, -0.009683, -0.006629, -0.007545, -0.003549, -0.004883, -0.001221, -0.001423, 0.001167, 0.010410, 0.016546, 0.018708, 0.020326, 0.019541, 0.019735, 0.018124, 0.020468
#*# 	  -0.049674, -0.048633, -0.047145, -0.047464, -0.045068, -0.040844, -0.041573, -0.032392, -0.024601, -0.031111, -0.011412, -0.019975, -0.007855, -0.007413, -0.010933, -0.007227, -0.008890, -0.007377, -0.005531, 0.003169, 0.005675, 0.008061, 0.012988, 0.017836, 0.022799, 0.022919, 0.022840, 0.022374, 0.019179, 0.016499
#*# 	  -0.048091, -0.044906, -0.044586, -0.046197, -0.045097, -0.037763, -0.035176, -0.029868, -0.023095, -0.031291, -0.010654, -0.013679, -0.012819, 0.001022, -0.009696, -0.004946, -0.007220, -0.004438, -0.002867, 0.002385, 0.008519, 0.009975, 0.018138, 0.020641, 0.027361, 0.027475, 0.026650, 0.025825, 0.024463, 0.018030
#*# 	  -0.048382, -0.045538, -0.043376, -0.044495, -0.043154, -0.038644, -0.035197, -0.033418, -0.024471, -0.023731, -0.018445, -0.007496, -0.018746, 0.003470, -0.009096, -0.004867, -0.007068, -0.005574, -0.002620, 0.002653, 0.012534, 0.012624, 0.020359, 0.022799, 0.027422, 0.028016, 0.029178, 0.026012, 0.024636, 0.020869
#*# 	  -0.047967, -0.046886, -0.044846, -0.045057, -0.042919, -0.039005, -0.034790, -0.031150, -0.028607, -0.013204, -0.027539, -0.001644, -0.017079, 0.001622, -0.007055, -0.003202, -0.004044, -0.002842, 0.000965, 0.003038, 0.012609, 0.014261, 0.019009, 0.025439, 0.028897, 0.027963, 0.029008, 0.027134, 0.026629, 0.024521
#*# 	  -0.049173, -0.046100, -0.043173, -0.045440, -0.042428, -0.040071, -0.037090, -0.027125, -0.033479, -0.006394, -0.028802, -0.001467, -0.015794, -0.004495, -0.005021, -0.001557, -0.001015, -0.002148, 0.003265, 0.002636, 0.011670, 0.018392, 0.016492, 0.025398, 0.026966, 0.027235, 0.027249, 0.028010, 0.026378, 0.023948
#*# 	  -0.049900, -0.046917, -0.045339, -0.047497, -0.043822, -0.040039, -0.039370, -0.022270, -0.035866, -0.008716, -0.029380, -0.008533, -0.016115, -0.007023, -0.002024, -0.000868, 0.001067, -0.001005, 0.002226, 0.006095, 0.008815, 0.017790, 0.016423, 0.022919, 0.025272, 0.026066, 0.026570, 0.024426, 0.024410, 0.023009
#*# 	  -0.048510, -0.046422, -0.043334, -0.048661, -0.044887, -0.037994, -0.040717, -0.027216, -0.033096, -0.017903, -0.025767, -0.016877, -0.016050, -0.010185, -0.002180, -0.001174, 0.002289, 0.002500, 0.003548, 0.009232, 0.008683, 0.015966, 0.019908, 0.024327, 0.025865, 0.026791, 0.024863, 0.024049, 0.024037, 0.020873
#*# 	  -0.048212, -0.046433, -0.042393, -0.046184, -0.046361, -0.036644, -0.041510, -0.031965, -0.027227, -0.029821, -0.020365, -0.020937, -0.013022, -0.007667, 0.000222, 0.000453, 0.004776, 0.004411, 0.009590, 0.007566, 0.016507, 0.019557, 0.025603, 0.025239, 0.027222, 0.026180, 0.024686, 0.024773, 0.024113, 0.020419
#*# 	  -0.047252, -0.045340, -0.041544, -0.046792, -0.045364, -0.034736, -0.039822, -0.029518, -0.023514, -0.033610, -0.011109, -0.020961, -0.006138, -0.004416, 0.001713, 0.003736, 0.008260, 0.004617, 0.015955, 0.008195, 0.023751, 0.023013, 0.028221, 0.028518, 0.028871, 0.028747, 0.027321, 0.026987, 0.025311, 0.022710
#*# 	  -0.047270, -0.044544, -0.040594, -0.044753, -0.042720, -0.034227, -0.040138, -0.024830, -0.022925, -0.030638, -0.003307, -0.018446, -0.001362, -0.003440, 0.001072, 0.004313, 0.010789, 0.004529, 0.019461, 0.010641, 0.027013, 0.023963, 0.028832, 0.033496, 0.031019, 0.031060, 0.028848, 0.029801, 0.026629, 0.025615
#*# 	  -0.047280, -0.045298, -0.041336, -0.046571, -0.042766, -0.036487, -0.041148, -0.025383, -0.027821, -0.025740, -0.006655, -0.021312, 0.000746, -0.003538, 0.002956, 0.002462, 0.010007, 0.002689, 0.017287, 0.011316, 0.025347, 0.025333, 0.025440, 0.032900, 0.028927, 0.033321, 0.030202, 0.032826, 0.030500, 0.028168
#*# 	  -0.048846, -0.047242, -0.041705, -0.047941, -0.043115, -0.036835, -0.039944, -0.023183, -0.032100, -0.019097, -0.015317, -0.020814, 0.000207, -0.005016, 0.006543, 0.001137, 0.010057, 0.006907, 0.016704, 0.012822, 0.022365, 0.027980, 0.024494, 0.033970, 0.028739, 0.034635, 0.030863, 0.036542, 0.035264, 0.031970
#*# 	  -0.051226, -0.048329, -0.043817, -0.049385, -0.045981, -0.034442, -0.039697, -0.019998, -0.038597, -0.017140, -0.019928, -0.019112, -0.003810, -0.008793, 0.004119, -0.000959, 0.008150, 0.006286, 0.013050, 0.015095, 0.016002, 0.027826, 0.024341, 0.032002, 0.029714, 0.033874, 0.028842, 0.037282, 0.034399, 0.034087
#*# 	  -0.052402, -0.049468, -0.044856, -0.047645, -0.047700, -0.031487, -0.041333, -0.021287, -0.036619, -0.018217, -0.021496, -0.018748, -0.006662, -0.010114, 0.003470, 0.001560, 0.009168, 0.012023, 0.010144, 0.020350, 0.013475, 0.031293, 0.027890, 0.030524, 0.030660, 0.033510, 0.030376, 0.037165, 0.038021, 0.035714
#*# 	  -0.053329, -0.052036, -0.047815, -0.046004, -0.052261, -0.029834, -0.043123, -0.025970, -0.032315, -0.025323, -0.026914, -0.021732, -0.009180, -0.009959, 0.000445, 0.005889, 0.005992, 0.016354, 0.006842, 0.025069, 0.013009, 0.030685, 0.027460, 0.030315, 0.034223, 0.035104, 0.032443, 0.037286, 0.036652, 0.036737
#*# 	  -0.053950, -0.050999, -0.048129, -0.044722, -0.054003, -0.033293, -0.038109, -0.034558, -0.027816, -0.034325, -0.026996, -0.021639, -0.012141, -0.005756, -0.000781, 0.008879, 0.001758, 0.016177, 0.007806, 0.028182, 0.014426, 0.028438, 0.027852, 0.027569, 0.033637, 0.035160, 0.032946, 0.037382, 0.035935, 0.037537
#*# 	  -0.054316, -0.053951, -0.050734, -0.047317, -0.054231, -0.042470, -0.033402, -0.043861, -0.025181, -0.040042, -0.027755, -0.022416, -0.017742, -0.005212, -0.001318, 0.005103, -0.000571, 0.012229, 0.004478, 0.022535, 0.013011, 0.023493, 0.025533, 0.026046, 0.032865, 0.033687, 0.031930, 0.037459, 0.035179, 0.035030
#*# 	  -0.052627, -0.050912, -0.046439, -0.047594, -0.050931, -0.047426, -0.031151, -0.045324, -0.025365, -0.039850, -0.027854, -0.026472, -0.021341, -0.009946, -0.001835, 0.001015, -0.000234, 0.008844, 0.000688, 0.015846, 0.010379, 0.020782, 0.024236, 0.028870, 0.032159, 0.029111, 0.032757, 0.034971, 0.032965, 0.034493
#*# 	  -0.052270, -0.052695, -0.047967, -0.049733, -0.048414, -0.051601, -0.034442, -0.043330, -0.026284, -0.034922, -0.025971, -0.028740, -0.019614, -0.012159, -0.004326, 0.002777, 0.000469, 0.008511, -0.000841, 0.010432, 0.009099, 0.017171, 0.023142, 0.027360, 0.029707, 0.025848, 0.032415, 0.030101, 0.032209, 0.032861
#*# 	  -0.051159, -0.050514, -0.044787, -0.050651, -0.047308, -0.052659, -0.040725, -0.040056, -0.030460, -0.029348, -0.024285, -0.023491, -0.019322, -0.010408, -0.008593, 0.004581, 0.002140, 0.008104, 0.001931, 0.009803, 0.008389, 0.013977, 0.022026, 0.025096, 0.028375, 0.026325, 0.031493, 0.026784, 0.033766, 0.032706
#*# 	  -0.052061, -0.050789, -0.044472, -0.051894, -0.045676, -0.053487, -0.044569, -0.039978, -0.034144, -0.024450, -0.025259, -0.019330, -0.019810, -0.010838, -0.009574, 0.002776, -0.001456, 0.007729, 0.001886, 0.008095, 0.007608, 0.011587, 0.020519, 0.020544, 0.027552, 0.028738, 0.030746, 0.027260, 0.032684, 0.029972
#*# 	  -0.053341, -0.049965, -0.044353, -0.051273, -0.045203, -0.051865, -0.044252, -0.039258, -0.033736, -0.024502, -0.024031, -0.017986, -0.016205, -0.010588, -0.008568, 0.000339, -0.002228, -0.001366, 0.001930, 0.004130, 0.006839, 0.009505, 0.018288, 0.019649, 0.028766, 0.029610, 0.028929, 0.028916, 0.032234, 0.029128
#*# 	  -0.054619, -0.050005, -0.045530, -0.051236, -0.047883, -0.048737, -0.045221, -0.040757, -0.035021, -0.027081, -0.023983, -0.016185, -0.014475, -0.009793, -0.010636, -0.002237, -0.002580, -0.008601, 0.002116, -0.006574, 0.007565, 0.008283, 0.019676, 0.019444, 0.028509, 0.028303, 0.028730, 0.028913, 0.030618, 0.028848
#*# 	  -0.053982, -0.048738, -0.046476, -0.048983, -0.049942, -0.047176, -0.049627, -0.042396, -0.039134, -0.030695, -0.026250, -0.018529, -0.014290, -0.009677, -0.011586, -0.003629, -0.005327, -0.009316, -0.002453, -0.010307, 0.004402, 0.004894, 0.018299, 0.020774, 0.026212, 0.025935, 0.027848, 0.027481, 0.029131, 0.027990
#*# 	  -0.054340, -0.049439, -0.047741, -0.049506, -0.052313, -0.048202, -0.052903, -0.044829, -0.044642, -0.035060, -0.031652, -0.022669, -0.016716, -0.011544, -0.014191, -0.009811, -0.008568, -0.011375, -0.006964, -0.006695, -0.003297, 0.003207, 0.008853, 0.021900, 0.021422, 0.025066, 0.025701, 0.026209, 0.028005, 0.026293
#*# 	  -0.054368, -0.049053, -0.047109, -0.049584, -0.052342, -0.050120, -0.054341, -0.048695, -0.049782, -0.040759, -0.038816, -0.027224, -0.022871, -0.014487, -0.017554, -0.013066, -0.013790, -0.014533, -0.010937, -0.005165, -0.005017, 0.005066, -0.000118, 0.017213, 0.012061, 0.025116, 0.022606, 0.023704, 0.024959, 0.023641
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 200.0
#*# min_y = 34.0
#*# max_y = 180.0
