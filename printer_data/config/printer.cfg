[include mainsail.cfg]
# This file contains common pin mappings for the BIGTREETECH Manta M8P V1.1
# To use this config, the firmware should be compiled for the
# STM32G0B1 with a "8KiB bootloader" and USB communication.

# See docs/Config_Reference.md for a description of parameters.
[include mcu_definitions/mantaM8P.cfg]
[include mcu_definitions/ebb36.cfg]
[include kinematics.cfg]
[include hardware/xy.cfg]
[include hardware/z.cfg]
[include hardware/temperature_sensors/ebb36_temp.cfg]
[include hardware/temperature_sensors/mcu_temp.cfg]
[include hardware/temperature_sensors/rpi_temp.cfg]
[include hardware/probe/qgl.cfg]
[include spoolman.cfg]
[include cartographer.cfg]

[force_move]
enable_force_move: true

[heater_bed]
heater_pin: PB5
sensor_type: ATC Semitec 104GT-2
sensor_pin: PA0
##	Adjust Max Power so your heater doesn't warp your bed
max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[extruder]
step_pin: ebb36: PD0
dir_pin: !ebb36: PD1
enable_pin: !ebb36: PD2
microsteps: 16
rotation_distance: 33.500
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: ebb36: PB13
sensor_pin: ebb36: PA3
sensor_type: EPCOS 100K B57560G104F
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: -250
max_temp: 250

## EXTRUDER MOTOR
[tmc2209 extruder]
uart_pin: ebb36: PA15
run_current: 0.650
stealthchop_threshold: 999999

[homing_override]
gcode:

  {% if not 'Z' in params and not 'Y' in params and 'X' in params %}
  _HOME_X
  G4 P1000
  _HOME_X
  {% elif not 'Z' in params and not 'X' in params and 'Y' in params %}
  _HOME_Y
  G4 P1000
  _HOME_Y
  {% elif not 'Z' in params and 'X' in params and 'Y' in params %}
  _HOME_Y
  G4 P1000
  _HOME_Y
  _HOME_X
  G4 P1000
  _HOME_X
  {% elif 'Z' in params and not 'X' in params and not 'Y' in params %}
  G28 Z
  G0 Z10
  {% else %}
  SET_KINEMATIC_POSITION HOMED_AXIS=Z0
  G0 Z10
  SET_KINEMATIC_POSITION CLEAR_HOMED=Z
  _HOME_Y
  G4 P1000
  _HOME_Y
  _HOME_X
  G4 P1000
  _HOME_X
  G0 X95 Y95
  G28 Z
  G0 Z10

  {% endif %} 


[gcode_macro _HOME_X]
gcode:
    # Always use consistent run_current on A/B steppers during sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 X F1200
    # Move away
    G91
    G1 X10 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}
    
[gcode_macro _HOME_Y]
gcode:
    # Set current for sensorless homing
    {% set RUN_CURRENT_X = printer.configfile.settings['tmc2209 stepper_x'].run_current|float %}
    {% set RUN_CURRENT_Y = printer.configfile.settings['tmc2209 stepper_y'].run_current|float %}
    {% set HOME_CURRENT = 0.7 %}
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={HOME_CURRENT}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={HOME_CURRENT}
    
    # Home
    G28 Y F1200
    # Move away
    G91
    G1 Y10 F1200
    
    # Wait just a second… (give StallGuard registers time to clear)
    G4 P1000
    # Set current during print
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={RUN_CURRENT_X}
    SET_TMC_CURRENT STEPPER=stepper_y CURRENT={RUN_CURRENT_Y}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [scanner]
#*# mode = touch
#*#
#*# [scanner model default]
#*# model_coef = 1.525655903632888,
#*# 	1.7948450800481244,
#*# 	0.7051435344273781,
#*# 	0.40159627849029367,
#*# 	0.49453663919056695,
#*# 	0.11937565953471407,
#*# 	-0.2742073971199309,
#*# 	-0.1571390425533812,
#*# 	0.09577401982704113,
#*# 	0.2965964106937697
#*# model_domain = 3.172883330894801e-07,3.3008388270039953e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 27.285727
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.064377, -0.054020, -0.057296, -0.057522, -0.060109, -0.056898, -0.058168, -0.049567, -0.049886, -0.039881, -0.037404, -0.031167, -0.012282, -0.025915, 0.003126, -0.009599, -0.004831, -0.010581, -0.010228, -0.013674, -0.004096, -0.004786, 0.004810, 0.006247, 0.009385, 0.010281, 0.012474, 0.011955, 0.009799, 0.007765
#*# 	  -0.059223, -0.053498, -0.055164, -0.054076, -0.054394, -0.049456, -0.048808, -0.039768, -0.043687, -0.033626, -0.030527, -0.029960, -0.008911, -0.020456, -0.000461, -0.008383, -0.007091, -0.009327, -0.008081, -0.009345, -0.001634, -0.001670, 0.005194, 0.007806, 0.012736, 0.013804, 0.012601, 0.013345, 0.012453, 0.010462
#*# 	  -0.053259, -0.048492, -0.050714, -0.052416, -0.050370, -0.046024, -0.044237, -0.038265, -0.037992, -0.031700, -0.025231, -0.028632, -0.005635, -0.017748, -0.005603, -0.007815, -0.008108, -0.007512, -0.004033, -0.004589, 0.000132, -0.000432, 0.007718, 0.013705, 0.014931, 0.017433, 0.014948, 0.014691, 0.014200, 0.016250
#*# 	  -0.049015, -0.046300, -0.047895, -0.049720, -0.047812, -0.042905, -0.041759, -0.034201, -0.030064, -0.028716, -0.017223, -0.022338, -0.002350, -0.013004, -0.008313, -0.006733, -0.008733, -0.006225, -0.005061, -0.000531, -0.000482, 0.003979, 0.010993, 0.017026, 0.019072, 0.020319, 0.018675, 0.018761, 0.017181, 0.018681
#*# 	  -0.046609, -0.044867, -0.044724, -0.045557, -0.043945, -0.036552, -0.038638, -0.031061, -0.023681, -0.029632, -0.008936, -0.017161, -0.004258, -0.005379, -0.009939, -0.005990, -0.009810, -0.006674, -0.006473, 0.002157, 0.004099, 0.007837, 0.015398, 0.020360, 0.023103, 0.023315, 0.021870, 0.021869, 0.018369, 0.015111
#*# 	  -0.045766, -0.042843, -0.042182, -0.043115, -0.041676, -0.036587, -0.036216, -0.030068, -0.021096, -0.028508, -0.006081, -0.009872, -0.010816, 0.003756, -0.009496, -0.004413, -0.007987, -0.006168, -0.004906, 0.001897, 0.009487, 0.010197, 0.018581, 0.021830, 0.025818, 0.026385, 0.025850, 0.024848, 0.022061, 0.017069
#*# 	  -0.043467, -0.041486, -0.040426, -0.043098, -0.040531, -0.036212, -0.033368, -0.031020, -0.022031, -0.021249, -0.015340, -0.003006, -0.015318, 0.006029, -0.008454, -0.003089, -0.008034, -0.006014, -0.002503, 0.002015, 0.012395, 0.014092, 0.021048, 0.023239, 0.026778, 0.028018, 0.027632, 0.026407, 0.024865, 0.021362
#*# 	  -0.044521, -0.042025, -0.040055, -0.043325, -0.040517, -0.036917, -0.032885, -0.029318, -0.025928, -0.010060, -0.024301, 0.002661, -0.015928, 0.002950, -0.006291, -0.002401, -0.005157, -0.005199, -0.000509, 0.002078, 0.012526, 0.015460, 0.018786, 0.025425, 0.027771, 0.028094, 0.029470, 0.028115, 0.026647, 0.024197
#*# 	  -0.045240, -0.042764, -0.039728, -0.043066, -0.040090, -0.037554, -0.034398, -0.023926, -0.030204, -0.002118, -0.025900, 0.002188, -0.013563, -0.001259, -0.002956, -0.000956, -0.002003, -0.002994, 0.001516, 0.001698, 0.010386, 0.018115, 0.016303, 0.025554, 0.027386, 0.027702, 0.028493, 0.027887, 0.027342, 0.024263
#*# 	  -0.047234, -0.043472, -0.040091, -0.044087, -0.041576, -0.037655, -0.036898, -0.022358, -0.033207, -0.004870, -0.025834, -0.004776, -0.013530, -0.006275, -0.000395, -0.000600, 0.000498, -0.002228, -0.000041, 0.004450, 0.006141, 0.016387, 0.015009, 0.022766, 0.026054, 0.026647, 0.026747, 0.025701, 0.026302, 0.023342
#*# 	  -0.047102, -0.045128, -0.041018, -0.045753, -0.043298, -0.036770, -0.038951, -0.025373, -0.031530, -0.015800, -0.024642, -0.014926, -0.014516, -0.009163, -0.000250, -0.001716, 0.001730, 0.000490, 0.000607, 0.006107, 0.006851, 0.014264, 0.018704, 0.022212, 0.025558, 0.025814, 0.025121, 0.025038, 0.025419, 0.021894
#*# 	  -0.045302, -0.043680, -0.039856, -0.044403, -0.044609, -0.034620, -0.039869, -0.029570, -0.025651, -0.028212, -0.019293, -0.020462, -0.011945, -0.007595, 0.000774, 0.000651, 0.004582, 0.003138, 0.007739, 0.004396, 0.013806, 0.017472, 0.023819, 0.024310, 0.027744, 0.027170, 0.026377, 0.026329, 0.025930, 0.023657
#*# 	  -0.042757, -0.041900, -0.037909, -0.043745, -0.042557, -0.031430, -0.038130, -0.026406, -0.020908, -0.031590, -0.008658, -0.018346, -0.004074, -0.003222, 0.003102, 0.004747, 0.007976, 0.003181, 0.014197, 0.005445, 0.021531, 0.020319, 0.026539, 0.027887, 0.029876, 0.029757, 0.028371, 0.028289, 0.028208, 0.025182
#*# 	  -0.042432, -0.041975, -0.037423, -0.042871, -0.040178, -0.031256, -0.036531, -0.022627, -0.021200, -0.028952, -0.001254, -0.017353, 0.001645, -0.001762, 0.003292, 0.004451, 0.009347, 0.002729, 0.016458, 0.007367, 0.024128, 0.022150, 0.025016, 0.030793, 0.031100, 0.031886, 0.030363, 0.031248, 0.030333, 0.028200
#*# 	  -0.041248, -0.039975, -0.036694, -0.044133, -0.040392, -0.034286, -0.038077, -0.022576, -0.025431, -0.023073, -0.003261, -0.019300, 0.003689, -0.002467, 0.004537, 0.002906, 0.010160, 0.003113, 0.016815, 0.008807, 0.021837, 0.023218, 0.023524, 0.032778, 0.030075, 0.034802, 0.031845, 0.034296, 0.032463, 0.030481
#*# 	  -0.044759, -0.042940, -0.038580, -0.045435, -0.041300, -0.034974, -0.037645, -0.020206, -0.030845, -0.017270, -0.011234, -0.020611, 0.002286, -0.002838, 0.006368, 0.001527, 0.010744, 0.005665, 0.015801, 0.012483, 0.019674, 0.025344, 0.022954, 0.033658, 0.030448, 0.037149, 0.032973, 0.037351, 0.034847, 0.034785
#*# 	  -0.047422, -0.043725, -0.039684, -0.046304, -0.042327, -0.031757, -0.036805, -0.017620, -0.035702, -0.014250, -0.017097, -0.016590, -0.001118, -0.005859, 0.006230, 0.000412, 0.009666, 0.008086, 0.013891, 0.014695, 0.014723, 0.027908, 0.023396, 0.032612, 0.030816, 0.035449, 0.029795, 0.038230, 0.035838, 0.035673
#*# 	  -0.050049, -0.046900, -0.043379, -0.045592, -0.045164, -0.028650, -0.039012, -0.016411, -0.035225, -0.016006, -0.021328, -0.015505, -0.003787, -0.007241, 0.005368, 0.003718, 0.011069, 0.013139, 0.009846, 0.021014, 0.012623, 0.031825, 0.027357, 0.031161, 0.032821, 0.034281, 0.030543, 0.037952, 0.036963, 0.037457
#*# 	  -0.050663, -0.049294, -0.044939, -0.042895, -0.049486, -0.026099, -0.040479, -0.022278, -0.029738, -0.022141, -0.023700, -0.019394, -0.005622, -0.005183, 0.004190, 0.008605, 0.008093, 0.018700, 0.008446, 0.027534, 0.013613, 0.032296, 0.028257, 0.030948, 0.035625, 0.036048, 0.032714, 0.038233, 0.037158, 0.037908
#*# 	  -0.050939, -0.049360, -0.045980, -0.041351, -0.050647, -0.028285, -0.035132, -0.030490, -0.025257, -0.031407, -0.023939, -0.018550, -0.008769, -0.002426, 0.003090, 0.012549, 0.004598, 0.020685, 0.010248, 0.030387, 0.015652, 0.029954, 0.029513, 0.029547, 0.035463, 0.036141, 0.033274, 0.038165, 0.037155, 0.037657
#*# 	  -0.052302, -0.051064, -0.047934, -0.043201, -0.052811, -0.038259, -0.030665, -0.040367, -0.022818, -0.039053, -0.025351, -0.019318, -0.015576, -0.004071, 0.001636, 0.007687, 0.002333, 0.015170, 0.005772, 0.024707, 0.014210, 0.024413, 0.025494, 0.027547, 0.033607, 0.034725, 0.032786, 0.038052, 0.035045, 0.036328
#*# 	  -0.050340, -0.049593, -0.045240, -0.043525, -0.048457, -0.043626, -0.027846, -0.042801, -0.022027, -0.038474, -0.025253, -0.023584, -0.018072, -0.007530, 0.001874, 0.004776, 0.002880, 0.012396, 0.003043, 0.017284, 0.011553, 0.021461, 0.024559, 0.028515, 0.033595, 0.030591, 0.033785, 0.035879, 0.033742, 0.035676
#*# 	  -0.047557, -0.049473, -0.043729, -0.045459, -0.045207, -0.047245, -0.030241, -0.040159, -0.023015, -0.032855, -0.023042, -0.025738, -0.017796, -0.008975, -0.001674, 0.005848, 0.003395, 0.011231, 0.001066, 0.012382, 0.009713, 0.018239, 0.023719, 0.028100, 0.031635, 0.027295, 0.033302, 0.031214, 0.033356, 0.034052
#*# 	  -0.046304, -0.046940, -0.041784, -0.046259, -0.043274, -0.049103, -0.037002, -0.036461, -0.026906, -0.026425, -0.021549, -0.019914, -0.016209, -0.008016, -0.005928, 0.007430, 0.004128, 0.011307, 0.003241, 0.012388, 0.009845, 0.014377, 0.023413, 0.026047, 0.029763, 0.028191, 0.032675, 0.028615, 0.035356, 0.034207
#*# 	  -0.046797, -0.046137, -0.040153, -0.047489, -0.041872, -0.049678, -0.041407, -0.036900, -0.031346, -0.021774, -0.022266, -0.015077, -0.016553, -0.008184, -0.006798, 0.005661, 0.000345, 0.009526, 0.003425, 0.009634, 0.009219, 0.011902, 0.020902, 0.022452, 0.029798, 0.029711, 0.032706, 0.028796, 0.034782, 0.031031
#*# 	  -0.047472, -0.045163, -0.041316, -0.047378, -0.041226, -0.046814, -0.041481, -0.036122, -0.030838, -0.020689, -0.021708, -0.013507, -0.013006, -0.007127, -0.006292, 0.003047, 0.000427, 0.001690, 0.004724, 0.005480, 0.008785, 0.010970, 0.020055, 0.020480, 0.029736, 0.031725, 0.031464, 0.030643, 0.034340, 0.029550
#*# 	  -0.049577, -0.046220, -0.042153, -0.048127, -0.044529, -0.045813, -0.042434, -0.037726, -0.031646, -0.023453, -0.021235, -0.012666, -0.011291, -0.006571, -0.007792, 0.000802, 0.000869, -0.006275, 0.004225, -0.004548, 0.009203, 0.009844, 0.021046, 0.020685, 0.031168, 0.030756, 0.030963, 0.030947, 0.032487, 0.029234
#*# 	  -0.051349, -0.047418, -0.044886, -0.049495, -0.049048, -0.045581, -0.047701, -0.039123, -0.036400, -0.027757, -0.023290, -0.014477, -0.011145, -0.006553, -0.009255, -0.002050, -0.002904, -0.007142, 0.000218, -0.007959, 0.006548, 0.007625, 0.021073, 0.023254, 0.029184, 0.028401, 0.031039, 0.029494, 0.031709, 0.029725
#*# 	  -0.052321, -0.048609, -0.047422, -0.049558, -0.051278, -0.047812, -0.051991, -0.043296, -0.042999, -0.033454, -0.029264, -0.019836, -0.014262, -0.008704, -0.011099, -0.007015, -0.006271, -0.009264, -0.004801, -0.004699, -0.000409, 0.004277, 0.011052, 0.023677, 0.023144, 0.026394, 0.027682, 0.027264, 0.029185, 0.026340
#*# 	  -0.054069, -0.049416, -0.047894, -0.051031, -0.052569, -0.050602, -0.054503, -0.047819, -0.049116, -0.039289, -0.036037, -0.024244, -0.019169, -0.010773, -0.013985, -0.009616, -0.011057, -0.011731, -0.008191, -0.002129, -0.001810, 0.007198, 0.002292, 0.020311, 0.014661, 0.028243, 0.025609, 0.025185, 0.027166, 0.024322
#*# x_count = 30
#*# y_count = 30
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 20.0
#*# max_x = 200.0
#*# min_y = 34.0
#*# max_y = 180.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 20.900
#*# pid_ki = 1.010
#*# pid_kd = 108.160
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 51.782
#*# pid_ki = 1.995
#*# pid_kd = 335.938
